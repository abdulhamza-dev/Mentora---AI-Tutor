{% extends 'core/base.html' %}
{% load static %}

{% block title %}Ask AI Teacher{% endblock %}

{% block content %}
<style>
    .interaction-hub {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 0;
        gap: 20px;
        position: relative;
    }

    .tutor-logo-container {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .tutor-logo {
        width: 100%;
        height: 100%;
        border-radius: 24px;
        object-fit: cover;
        position: relative;
        z-index: 2;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .glow-effect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: var(--accent-color);
        border-radius: 24px;
        filter: blur(20px);
        opacity: 0;
        z-index: 1;
        transition: opacity 0.3s;
    }

    .listening .glow-effect {
        opacity: 0.6;
        animation: pulse-glow 2s infinite ease-in-out;
    }

    @keyframes pulse-glow {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.4;
        }

        50% {
            transform: translate(-50%, -50%) scale(1.4);
            opacity: 0.7;
        }

        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.4;
        }
    }

    .listening-status {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        letter-spacing: 0.5px;
        height: 20px;
    }

    .voice-controls {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }

    .btn-stop-listening {
        background: rgba(255, 77, 77, 0.1);
        border: 1px solid rgba(255, 77, 77, 0.3);
        color: #ff4d4d;
    }

    .btn-stop-listening:hover {
        background: rgba(255, 77, 77, 0.2);
    }

    /* Day Sidebar Styles */
    .history-day-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        font-size: 0.85rem;
    }

    .history-day-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .history-day-item.completed {
        color: var(--teal);
        background: rgba(26, 188, 156, 0.05);
    }

    .history-day-item.completed:hover {
        background: rgba(26, 188, 156, 0.1);
    }

    .history-day-item.in_progress {
        color: var(--accent-color);
        background: rgba(110, 68, 255, 0.05);
        border: 1px solid rgba(110, 68, 255, 0.2);
    }

    .history-day-item.locked {
        color: var(--text-secondary);
        opacity: 0.5;
        cursor: not-allowed;
    }

    .day-status-icon {
        width: 16px;
        height: 16px;
    }

    .history-day-item.active {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }
</style>
<div class="app-container">
    <div class="stars-container" id="stars-container"></div>
    <!-- Sidebar for Chat History -->
    <aside class="sidebar">
        <button class="new-chat-btn" onclick="createNewChat()">
            <i data-lucide="plus" style="width: 18px;"></i>
            <span>New Chat</span>
        </button>
        <div class="history-label" id="sidebar-context-label">Recent Chats</div>
        <div id="history-list" class="history-list">
            <!-- Dynamic history items or Days will go here -->
        </div>

        <div class="sidebar-footer"
            style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
            {% if user.is_authenticated %}
            <a href="{% url 'account' %}" class="sidebar-link">
                <i data-lucide="user" style="width: 18px;"></i>
                <span>Profile</span>
            </a>
            <a href="{% url 'logout' %}?next=/" class="sidebar-link" style="color: var(--text-secondary);">
                <i data-lucide="log-out" style="width: 18px;"></i>
                <span>Log out</span>
            </a>
            {% else %}
            <a href="{% url 'login' %}" class="sidebar-link">
                <i data-lucide="log-in" style="width: 18px;"></i>
                <span>Log in / Sign up</span>
            </a>
            {% endif %}
        </div>
    </aside>

    <!-- Main Chat Workspace -->
    <main class="main-chat">
        <header class="teacher-header">
            <h2 style="font-size: 1rem; font-weight: 600;">Antigravity - {{ subject }} Tutor</h2>
            <div id="subject-progress" class="history-progress-badge"
                style="background: rgba(26, 188, 156, 0.1); border: 1px solid rgba(26, 188, 156, 0.3); padding: 4px 12px; border-radius: 100px; color: var(--teal); font-size: 0.75rem; font-weight: 500;">
                Day {{ current_day }}
            </div>
            <div class="voice-controls">
                <button id="toggle-listening-btn" class="btn-secondary btn-stop-listening">
                    <i data-lucide="mic-off" style="width: 16px;"></i>
                    <span>Stop Listening</span>
                </button>
            </div>
        </header>

        <div class="interaction-hub">
            <div id="logo-container" class="tutor-logo-container">
                <div class="glow-effect"></div>
                <img src="{% static 'core/images/logo.png' %}" alt="Logo" class="tutor-logo">
            </div>
            <div id="listening-text" class="listening-status">Listening...</div>
        </div>

        <!-- Message Stream -->
        <div id="chat-stream" class="chat-stream">
            <div class="message-bubble message-ai">
                <div class="avatar-icon">
                    <img src="{% static 'core/images/logo.png' %}" alt="Logo"
                        style="width: 24px; height: 24px; border-radius: 4px;">
                </div>
                <div class="message-text">Hello! I'm your AI Tutor. What would you like to learn today?</div>
            </div>
        </div>

        <!-- Input Panel -->
        <footer class="input-panel" style="background: none;">
            <div class="input-container">
                <button id="mic-btn" class="btn-icon"
                    style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;">
                    <i data-lucide="mic" style="width: 20px;"></i>
                </button>
                <input type="text" id="student-question" class="chat-input" placeholder="Message AI Teacher..."
                    autocomplete="off">
                <button id="ask-btn" class="btn-submit">
                    <i data-lucide="arrow-up" style="width: 20px;"></i>
                </button>
            </div>
            <div class="controls">
                <button id="stop-btn" class="btn-secondary" title="Stop speaking">
                    <i data-lucide="square" style="width: 14px; fill: white;"></i>
                    Stop Talking
                </button>
                <button class="btn-secondary" onclick="createNewChat()">
                    <i data-lucide="refresh-cw" style="width: 14px;"></i>
                    Reset
                </button>
            </div>
        </footer>
    </main>
</div>

<script>
    // Initialize Lucide Icons
    lucide.createIcons();

    const logoContainer = document.getElementById('logo-container');
    const listeningText = document.getElementById('listening-text');
    const toggleListeningBtn = document.getElementById('toggle-listening-btn');
    const questionInput = document.getElementById('student-question');
    const askBtn = document.getElementById('ask-btn');
    const micBtn = document.getElementById('mic-btn');
    const chatStream = document.getElementById('chat-stream');
    const historyList = document.getElementById('history-list');
    const sidebarContextLabel = document.getElementById('sidebar-context-label');
    const currentSubject = "{{ subject }}";
    // Now ALL subjects use dynamic days except maybe "General Learning"
    const isDayMode = currentSubject.toLowerCase() !== "general learning";

    // Text-to-Speech Configuration
    const synth = window.speechSynthesis;
    const stopBtn = document.getElementById('stop-btn');

    // Stop Button Logic (Cancel Speech)
    stopBtn.addEventListener('click', () => {
        synth.cancel();
    });

    let isSpeaking = false;
    let isListening = false;
    let shouldListen = true;

    // Speech-to-Text Configuration
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isListening = true;
            logoContainer.classList.add('listening');
            listeningText.innerText = "I'm listening...";
            micBtn.classList.add('recording');
        };

        recognition.onend = () => {
            isListening = false;
            logoContainer.classList.remove('listening');
            micBtn.classList.remove('recording');

            // Auto-restart if we should still be listening and not speaking
            if (shouldListen && !isSpeaking) {
                try { recognition.start(); } catch (e) { }
            } else if (!shouldListen) {
                listeningText.innerText = "Listening stopped.";
            }
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            if (transcript.trim()) {
                addMessage(transcript, true);
                askTeacher(transcript);
            }
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            if (event.error === 'no-speech') {
                // Silently ignore or show hidden status
            }
        };
    } else {
        micBtn.style.display = 'none';
        listeningText.innerText = "Voice recognition not supported.";
    }

    function toggleListening() {
        if (isListening) {
            shouldListen = false;
            recognition.stop();
            toggleListeningBtn.querySelector('span').innerText = "Resume Listening";
            toggleListeningBtn.querySelector('i').setAttribute('data-lucide', 'mic');
            toggleListeningBtn.classList.remove('btn-stop-listening');
        } else {
            shouldListen = true;
            recognition.start();
            toggleListeningBtn.querySelector('span').innerText = "Stop Listening";
            toggleListeningBtn.querySelector('i').setAttribute('data-lucide', 'mic-off');
            toggleListeningBtn.classList.add('btn-stop-listening');
        }
        lucide.createIcons();
    }

    toggleListeningBtn.addEventListener('click', toggleListening);
    micBtn.addEventListener('click', () => {
        if (!isListening) {
            shouldListen = true;
            recognition.start();
        }
    });

    function speak(text) {
        if (!synth) return;
        synth.cancel();

        isSpeaking = true;
        // Stop listening while speaking to avoid feedback
        if (isListening) recognition.stop();

        const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F3FB}-\u{1F3FF}\u{1F400}-\u{1F4FF}\u{1F500}-\u{1F5FF}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F02B}\u{1F004}\u{1F0CF}]/gu, '');

        const utterance = new SpeechSynthesisUtterance(cleanText);
        const voices = synth.getVoices();

        // Optimize voice selection for a "warm/calm/natural" teacher vibe
        const preferredVoices = ['Samantha', 'Google US English', 'Daniel', 'Microsoft Zira Desktop', 'Natural', 'English (United States)'];
        utterance.voice = voices.find(v => preferredVoices.some(pv => v.name.includes(pv))) || voices[0];

        utterance.pitch = 1.0;  // Slightly higher for a friendly kid-teacher vibe
        utterance.rate = 0.85;  // Slightly slower for patient, calm delivery
        utterance.volume = 1;

        utterance.onend = () => {
            isSpeaking = false;
            if (shouldListen) recognition.start();
        };

        synth.speak(utterance);
    }

    function addMessage(text, isUser = false) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isUser ? 'message-user' : 'message-ai'}`;

        let avatarHtml = '';
        if (!isUser) {
            avatarHtml = `
                <div class="avatar-icon">
                    <img src="{% static 'core/images/logo.png' %}" alt="Logo" style="width: 24px; height: 24px; border-radius: 4px;">
                </div>
            `;
        } else {
            avatarHtml = `<div class="avatar-icon" style="background: #444654;"><i data-lucide="user" style="width: 18px; color: white;"></i></div>`;
        }

        bubble.innerHTML = `${avatarHtml}<div class="message-text">${text}</div>`;
        chatStream.appendChild(bubble);
        chatStream.scrollTop = chatStream.scrollHeight;
        lucide.createIcons(); // Initialize icons for user messages
    }

    async function loadHistory() {
        if (isDayMode) {
            return await loadSubjectDays();
        }

        try {
            const response = await fetch('/history/');
            const data = await response.json();
            const history = data.history || [];

            sidebarContextLabel.innerText = "Recent Chats";
            historyList.innerHTML = '';
            history.forEach(item => {
                const container = document.createElement('div');
                container.className = 'history-item-container';

                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = item.question;
                div.onclick = () => {
                    chatStream.innerHTML = '';
                    addMessage(item.question, true);
                    addMessage(item.answer, false);
                };

                const actions = document.createElement('div');
                actions.className = 'history-actions';

                const menuBtn = document.createElement('button');
                menuBtn.className = 'history-menu-btn';
                menuBtn.innerHTML = '<i data-lucide="more-horizontal" style="width: 16px;"></i>';
                menuBtn.onclick = (e) => {
                    e.stopPropagation();
                    const dropdown = actions.querySelector('.history-dropdown');
                    // Hide other dropdowns
                    document.querySelectorAll('.history-dropdown').forEach(d => {
                        if (d !== dropdown) d.classList.remove('show');
                    });
                    dropdown.classList.toggle('show');
                };

                const dropdown = document.createElement('div');
                dropdown.className = 'history-dropdown';

                const deleteItem = document.createElement('div');
                deleteItem.className = 'history-dropdown-item';
                deleteItem.innerHTML = '<i data-lucide="trash-2" style="width: 14px;"></i><span>Delete</span>';
                deleteItem.onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(item.id, container);
                };

                dropdown.appendChild(deleteItem);
                actions.appendChild(menuBtn);
                actions.appendChild(dropdown);

                container.appendChild(div);
                historyList.appendChild(container);
            });
            lucide.createIcons();
            return history;
        } catch (e) {
            console.error('History load failed', e);
            return [];
        }
    }

    async function loadSubjectDays() {
        try {
            const response = await fetch(`/subject/days/?subject=${encodeURIComponent(currentSubject)}`);
            const data = await response.json();
            const days = data.days || [];

            sidebarContextLabel.innerText = `${currentSubject} Days`;
            historyList.innerHTML = '';

            days.forEach(d => {
                const div = document.createElement('div');
                div.className = `history-day-item ${d.status}`;
                if (d.day === parseInt("{{ current_day }}")) div.classList.add('active');

                let icon = 'lock';
                if (d.status === 'completed') icon = 'check-circle';
                if (d.status === 'in_progress') icon = 'play-circle';

                div.innerHTML = `
                    <span>Day ${d.day}</span>
                    <i data-lucide="${icon}" class="day-status-icon"></i>
                `;

                if (d.status !== 'locked') {
                    div.onclick = () => {
                        document.querySelectorAll('.history-day-item').forEach(i => i.classList.remove('active'));
                        div.classList.add('active');
                        loadDayHistory(d.day);
                    };
                }

                historyList.appendChild(div);
            });
            lucide.createIcons();
            return days;
        } catch (e) {
            console.error('Subject days load failed', e);
            return [];
        }
    }

    async function loadDayHistory(day) {
        try {
            const response = await fetch(`/history/?topic=${encodeURIComponent(currentSubject)}&day=${day}`);
            const data = await response.json();
            const history = data.history || [];

            chatStream.innerHTML = '';

            // Greeting logic
            let welcomeHeader = `Welcome to your ${currentSubject} journey! ðŸš€`;
            let daySpecific = `Today is Day ${day}. Let's continue our lesson!`;

            if (currentSubject.toLowerCase().includes("history")) {
                const chapters = ["Dawn of Civilization", "Glory of Greece", "Might of Rome", "Middle Ages", "Renaissance", "Industrial Revolution", "Modern Age"];
                const dayName = chapters[day - 1] || "World History";
                daySpecific = `Today is Day ${day}. We're exploring ${dayName}! ðŸ›ï¸ðŸ“œ`;
            } else if (currentSubject.toLowerCase().includes("astronomy")) {
                const chapters = ["Our Solar System", "Burning Stars", "The Milky Way", "Black Holes", "Space Exploration", "The Big Bang", "Galaxies Beyond"];
                const dayName = chapters[day - 1] || "the Universe";
                daySpecific = `Today is Day ${day}. We're looking at ${dayName}! ðŸŒŒâœ¨`;
            } else if (currentSubject.toLowerCase().includes("biology") || currentSubject.toLowerCase().includes("science")) {
                const chapters = ["Building Blocks: Cells", "Plant Life", "Animal Kingdom", "Human Body", "Ecosystems", "Genetics", "Evolution"];
                const dayName = chapters[day - 1] || "Science";
                daySpecific = `Today is Day ${day}. We're studying ${dayName}! ðŸŒ¿ðŸ”¬`;
            } else if (currentSubject.toLowerCase().includes("philosophy")) {
                const chapters = ["Great Ideas", "Ethics", "Logic", "Ancient Thinkers", "The Nature of Mind", "Justice", "Existentialism"];
                const dayName = chapters[day - 1] || "Philosophy";
                daySpecific = `Today is Day ${day}. We're exploring ${dayName}! ðŸ§ ðŸ’¡`;
            }

            const greeting = history.length > 0 ? `Welcome back to Day ${day}! I'm ready to continue our lesson on ${currentSubject}.` : `${welcomeHeader} ${daySpecific}`;

            if (history.length > 0) {
                // Show returning greeting briefly or as first message
                addMessage(greeting, false);
                history.forEach(item => {
                    addMessage(item.question, true);
                    addMessage(item.answer, false);
                });
            } else {
                addMessage(greeting, false);
                speak(greeting);
            }
        } catch (e) {
            console.error('Day history load failed', e);
        }
    }

    async function deleteConversation(id, element) {
        if (!confirm('Are you sure you want to delete this chat?')) return;
        try {
            const response = await fetch(`/history/delete/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            if (response.ok) {
                element.remove();
            } else {
                alert('Failed to delete conversation');
            }
        } catch (e) {
            console.error('Delete failed', e);
        }
    }

    // Close dropdowns on outside click
    document.addEventListener('click', () => {
        document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show'));
    });

    function createNewChat() {
        chatStream.innerHTML = '';
        const openingLine = "Hello! I'm your {{ subject }} Tutor. What would you like to learn today?";
        addMessage(openingLine, false);
        speak(openingLine);
    }

    async function askTeacher(predefinedQuestion = null) {
        const question = predefinedQuestion || questionInput.value.trim();
        if (!question) return;

        if (!predefinedQuestion) addMessage(question, true);
        questionInput.value = '';

        askBtn.disabled = true;
        const loadingBubble = document.createElement('div');
        loadingBubble.className = 'message-bubble message-ai loading';
        loadingBubble.innerHTML = '<span class="loading-dots">Thinking<span>.</span><span>.</span><span>.</span></span>';
        chatStream.appendChild(loadingBubble);
        chatStream.scrollTop = chatStream.scrollHeight;

        try {
            const response = await fetch('/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ question: question, topic: "{{ subject }}" })
            });

            const data = await response.json();
            chatStream.removeChild(loadingBubble);

            if (data.limit_reached) {
                const msg = data.error || "I've reached my free limit for now! Please upgrade to keep learning.";
                addMessage(msg, false);
                speak(msg);
                setTimeout(() => {
                    window.location.href = data.is_logged_in ? '/pricing/' : '/signup/';
                }, 4000);
                return;
            }

            if (data.answer) {
                addMessage(data.answer, false);
                speak(data.answer);
                loadHistory(); // Refresh sidebar
            }
        } catch (error) {
            chatStream.removeChild(loadingBubble);
            addMessage("I'm having trouble connecting right now.", false);
        } finally {
            askBtn.disabled = false;
        }
    }

    askBtn.addEventListener('click', askTeacher);
    questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askTeacher();
    });

    // Initial load
    window.onload = async () => {
        await loadHistory();

        if (isDayMode) {
            const currentDay = parseInt("{{ current_day }}");
            await loadDayHistory(currentDay);
        } else {
            createNewChat();
        }
    };

    // Generate Moving Stars
    function generateStars() {
        const container = document.getElementById('stars-container');
        const count = 100;
        for (let i = 0; i < count; i++) {
            const star = document.createElement('div');
            const size = Math.random() > 0.8 ? 'lg' : (Math.random() > 0.4 ? 'md' : 'sm');
            star.className = `star star-${size}`;

            star.style.left = `${Math.random() * 100}vw`;
            star.style.top = `${Math.random() * 100}vh`;

            const duration = 50 + Math.random() * 100;
            star.style.animationDuration = `${duration}s`;
            star.style.animationDelay = `${-Math.random() * duration}s`;

            container.appendChild(star);
        }
    }
    generateStars();
</script>
{% endblock %}