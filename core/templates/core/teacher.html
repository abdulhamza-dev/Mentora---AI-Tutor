{% extends 'core/base.html' %}
{% load static %}

{% block title %}Ask AI Teacher{% endblock %}

{% block content %}
<div class="app-container">
    <div class="stars-container" id="stars-container"></div>
    <!-- Sidebar for Chat History -->
    <aside class="sidebar">
        <button class="new-chat-btn" onclick="createNewChat()">
            <i data-lucide="plus" style="width: 18px;"></i>
            <span>New Chat</span>
        </button>
        <div class="history-label">Recent Chats</div>
        <div id="history-list" class="history-list">
            <!-- Dynamic history items -->
        </div>

        <div class="sidebar-footer"
            style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
            {% if user.is_authenticated %}
            <a href="{% url 'account' %}" class="sidebar-link">
                <i data-lucide="user" style="width: 18px;"></i>
                <span>Profile</span>
            </a>
            <a href="{% url 'logout' %}?next=/" class="sidebar-link" style="color: var(--text-secondary);">
                <i data-lucide="log-out" style="width: 18px;"></i>
                <span>Log out</span>
            </a>
            {% else %}
            <a href="{% url 'login' %}" class="sidebar-link">
                <i data-lucide="log-in" style="width: 18px;"></i>
                <span>Log in / Sign up</span>
            </a>
            {% endif %}
        </div>
    </aside>

    <!-- Main Chat Workspace -->
    <main class="main-chat">
        <header class="teacher-header">
            <h2 style="font-size: 1rem; font-weight: 600;">AI Teacher</h2>
            <img src="{% static 'core/images/logo.png' %}" alt="Logo" class="header-avatar"
                style="width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border-color);">
        </header>

        <!-- Message Stream -->
        <div id="chat-stream" class="chat-stream">
            <div class="message-bubble message-ai">
                <div class="avatar-icon">
                    <img src="{% static 'core/images/logo.png' %}" alt="Logo"
                        style="width: 24px; height: 24px; border-radius: 4px;">
                </div>
                <div class="message-text">Hello! I'm your AI Tutor. What would you like to learn today?</div>
            </div>
        </div>

        <!-- Input Panel -->
        <footer class="input-panel" style="background: none;">
            <div class="input-container">
                <button id="mic-btn" class="btn-icon"
                    style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;">
                    <i data-lucide="mic" style="width: 20px;"></i>
                </button>
                <input type="text" id="student-question" class="chat-input" placeholder="Message AI Teacher..."
                    autocomplete="off">
                <button id="ask-btn" class="btn-submit">
                    <i data-lucide="arrow-up" style="width: 20px;"></i>
                </button>
            </div>
            <div class="controls">
                <button id="stop-btn" class="btn-secondary" title="Stop speaking">
                    <i data-lucide="square" style="width: 14px; fill: white;"></i>
                    Stop Talking
                </button>
                <button class="btn-secondary" onclick="createNewChat()">
                    <i data-lucide="refresh-cw" style="width: 14px;"></i>
                    Reset
                </button>
            </div>
        </footer>
    </main>
</div>

<script>
    // Initialize Lucide Icons
    lucide.createIcons();
    const questionInput = document.getElementById('student-question');
    const askBtn = document.getElementById('ask-btn');
    const micBtn = document.getElementById('mic-btn');
    const stopBtn = document.getElementById('stop-btn');
    const chatStream = document.getElementById('chat-stream');
    const historyList = document.getElementById('history-list');
    const teacherAvatar = document.querySelector('.header-teacher-avatar');

    // Text-to-Speech Configuration
    const synth = window.speechSynthesis;

    // Stop Button Logic
    stopBtn.addEventListener('click', () => {
        synth.cancel();
    });

    // Speech-to-Text Configuration
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            micBtn.classList.add('recording');
            questionInput.placeholder = "Listening...";
        };

        recognition.onend = () => {
            micBtn.classList.remove('recording');
            questionInput.placeholder = "Ask me anything...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            questionInput.value = transcript;
            askTeacher();
        };
    } else {
        micBtn.style.display = 'none';
    }

    micBtn.addEventListener('click', () => {
        if (recognition) recognition.start();
    });

    function speak(text) {
        if (!synth) return;
        synth.cancel();

        // Strip emojis and special characters for cleaner speech
        const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F3FB}-\u{1F3FF}\u{1F400}-\u{1F4FF}\u{1F500}-\u{1F5FF}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F02B}\u{1F004}\u{1F0CF}\u{1F018}-\u{1F02B}\u{1F004}\u{1F0CF}]/gu, '');

        const utterance = new SpeechSynthesisUtterance(cleanText);
        const voices = synth.getVoices();
        // Look for better sounding voices
        const preferredVoices = ['Google US English', 'Samantha', 'Microsoft Zira Desktop', 'Natural'];
        utterance.voice = voices.find(v => preferredVoices.some(pv => v.name.includes(pv))) || voices[0];

        utterance.pitch = 1.15; // Slightly higher for a friendly kid-teacher vibe
        utterance.rate = 0.95;  // Slightly slower to sound more natural and melodious
        utterance.volume = 1;
        utterance.onstart = () => teacherAvatar.classList.add('speaking-active');
        utterance.onend = () => teacherAvatar.classList.remove('speaking-active');
        synth.speak(utterance);
    }

    function addMessage(text, isUser = false) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isUser ? 'message-user' : 'message-ai'}`;

        let avatarHtml = '';
        if (!isUser) {
            avatarHtml = `
                <div class="avatar-icon">
                    <img src="{% static 'core/images/logo.png' %}" alt="Logo" style="width: 24px; height: 24px; border-radius: 4px;">
                </div>
            `;
        } else {
            avatarHtml = `<div class="avatar-icon" style="background: #444654;"><i data-lucide="user" style="width: 18px; color: white;"></i></div>`;
        }

        bubble.innerHTML = `${avatarHtml}<div class="message-text">${text}</div>`;
        chatStream.appendChild(bubble);
        chatStream.scrollTop = chatStream.scrollHeight;
        lucide.createIcons(); // Initialize icons for user messages
    }

    async function loadHistory() {
        try {
            const response = await fetch('/history/');
            const data = await response.json();
            historyList.innerHTML = '';
            data.history.forEach(item => {
                const container = document.createElement('div');
                container.className = 'history-item-container';

                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = item.question;
                div.onclick = () => {
                    chatStream.innerHTML = '';
                    addMessage(item.question, true);
                    addMessage(item.answer, false);
                };

                const actions = document.createElement('div');
                actions.className = 'history-actions';

                const menuBtn = document.createElement('button');
                menuBtn.className = 'history-menu-btn';
                menuBtn.innerHTML = '<i data-lucide="more-horizontal" style="width: 16px;"></i>';
                menuBtn.onclick = (e) => {
                    e.stopPropagation();
                    const dropdown = actions.querySelector('.history-dropdown');
                    // Hide other dropdowns
                    document.querySelectorAll('.history-dropdown').forEach(d => {
                        if (d !== dropdown) d.classList.remove('show');
                    });
                    dropdown.classList.toggle('show');
                };

                const dropdown = document.createElement('div');
                dropdown.className = 'history-dropdown';

                const deleteItem = document.createElement('div');
                deleteItem.className = 'history-dropdown-item';
                deleteItem.innerHTML = '<i data-lucide="trash-2" style="width: 14px;"></i><span>Delete</span>';
                deleteItem.onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(item.id, container);
                };

                dropdown.appendChild(deleteItem);
                actions.appendChild(menuBtn);
                actions.appendChild(dropdown);

                container.appendChild(div);
                container.appendChild(actions);
                historyList.appendChild(container);
            });
            lucide.createIcons();
        } catch (e) { console.error('History load failed', e); }
    }

    async function deleteConversation(id, element) {
        if (!confirm('Are you sure you want to delete this chat?')) return;
        try {
            const response = await fetch(`/history/delete/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            if (response.ok) {
                element.remove();
            } else {
                alert('Failed to delete conversation');
            }
        } catch (e) {
            console.error('Delete failed', e);
        }
    }

    // Close dropdowns on outside click
    document.addEventListener('click', () => {
        document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show'));
    });

    function createNewChat() {
        chatStream.innerHTML = `
            <div class="message-bubble message-ai">
                <div class="avatar-icon"><img src="{% static 'core/images/logo.png' %}" alt="Logo" style="width: 24px; height: 24px; border-radius: 4px;"></div>
                <div class="message-text">New chat started! What's on your mind?</div>
            </div>
        `;
    }

    async function askTeacher() {
        const question = questionInput.value.trim();
        if (!question) return;

        addMessage(question, true);
        questionInput.value = '';

        askBtn.disabled = true;
        const loadingBubble = document.createElement('div');
        loadingBubble.className = 'message-bubble message-ai loading';
        loadingBubble.innerHTML = '<span class="loading-dots">Thinking<span>.</span><span>.</span><span>.</span></span>';
        chatStream.appendChild(loadingBubble);
        chatStream.scrollTop = chatStream.scrollHeight;

        try {
            const response = await fetch('/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ question: question, topic: 'General Learning' })
            });

            const data = await response.json();
            chatStream.removeChild(loadingBubble);

            if (data.limit_reached) {
                addMessage("I've reached my free limit for now! Please log in or upgrade to keep learning.", false);
                speak("I've reached my free limit for now! Please log in or upgrade to keep learning.");
                setTimeout(() => {
                    window.location.href = data.error.includes("Guest") ? '/signup/' : '/pricing/';
                }, 3000);
                return;
            }

            if (data.answer) {
                addMessage(data.answer, false);
                speak(data.answer);
                loadHistory(); // Refresh sidebar
            }
        } catch (error) {
            chatStream.removeChild(loadingBubble);
            addMessage("I'm having trouble connecting right now.", false);
        } finally {
            askBtn.disabled = false;
        }
    }

    askBtn.addEventListener('click', askTeacher);
    questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askTeacher();
    });

    // Initial load
    loadHistory();

    // Generate Moving Stars
    function generateStars() {
        const container = document.getElementById('stars-container');
        const count = 100;
        for (let i = 0; i < count; i++) {
            const star = document.createElement('div');
            const size = Math.random() > 0.8 ? 'lg' : (Math.random() > 0.4 ? 'md' : 'sm');
            star.className = `star star-${size}`;

            star.style.left = `${Math.random() * 100}vw`;
            star.style.top = `${Math.random() * 100}vh`;

            const duration = 50 + Math.random() * 100;
            star.style.animationDuration = `${duration}s`;
            star.style.animationDelay = `${-Math.random() * duration}s`;

            container.appendChild(star);
        }
    }
    generateStars();
</script>
{% endblock %}